name: Github Action
on: [push, pull_request]

jobs:

  clean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Black formatting
        uses: lgeiger/black-action@v1.0.1
        with:
          args: "./"
      - name: Check for modified files
        id: git-check
        run: echo ::set-output name=modified::$(if git diff-index --quiet HEAD --; then echo "false"; else echo "true"; fi)
      - name: Push changes
        if: steps.git-check.outputs.modified == 'true'
        run: |
          git config --global user.email "r_s@me.com"
          git config --global user.name "romainsacchi"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY
          git checkout $GITHUB_HEAD_REF
          git commit -am "Black reformating"
          git push

  build-legacy:
    name: build â€¢ legacy (bw2io<0.9.0, bw2data<4.0.0, bw2calc<2.0.0)
    runs-on: ubuntu-latest
    needs: clean
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Upgrade pip
        run: python -m pip install -U pip
      - name: Write constraints
        run: |
          cat > constraints.txt <<'EOF'
          bw2io<0.9.0
          bw2data<4.0.0
          bw2calc<2.0.0
          EOF
          cat constraints.txt
      - name: Install package + deps under constraints
        run: |
          pip install -e . -c constraints.txt
          pip install pytest
      - name: Verify pinned versions & assert track
        run: |
          python - <<'PY'
          from packaging.version import Version
          import pkg_resources

          def ver(mod, dist_name):
            v = getattr(mod, "__version__", None)
            if isinstance(v, tuple):
              v = ".".join(map(str, v))
            if not v:
              v = pkg_resources.get_distribution(dist_name).version
            return str(v)

          import bw2io, bw2data
          v_io = ver(bw2io, "bw2io")
          v_data = ver(bw2data, "bw2data")
          print("bw2io:", v_io)
          print("bw2data:", v_data)

          PY
          pip check

      - name: Run tests (legacy)
        env:
          GITHUB_TOKEN: ${{ secrets.COVERALLS }}
          IAM_FILES_KEY: ${{ secrets.IAM_FILES_KEY }}
        run: pytest

  build-modern:
    name: build â€¢ modern (bw2io>=0.9.0, bw2data>=4.0.0, bw2calc>=2.0.0)
    runs-on: ubuntu-latest
    needs: clean
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Upgrade pip
        run: python -m pip install -U pip
      - name: Write constraints
        run: |
          cat > constraints.txt <<'EOF'
          bw2io>=0.9.0
          bw2data>=4.0.0
          bw2calc>=2.0.0
          EOF
          cat constraints.txt
      - name: Install package + deps under constraints
        run: |
          pip install -e . -c constraints.txt
          pip install pytest
      - name: Verify pinned versions & assert modern track
        run: |
          python - <<'PY'
          import sys
          import bw2io, bw2data
          from packaging.version import Version
          print("bw2io:", bw2io.__version__)
          print("bw2data:", bw2data.__version__)
          assert Version(bw2io.__version__) >= Version("0.9.0"), "bw2io is not >=0.9.0"
          assert Version(bw2data.__version__) >= Version("4.0.0"), "bw2data is not >=4.0.0"
          PY
          pip check
      - name: Run tests (modern)
        env:
          GITHUB_TOKEN: ${{ secrets.COVERALLS }}
          IAM_FILES_KEY: ${{ secrets.IAM_FILES_KEY }}
        run: pytest

  Pypi:
    runs-on: ubuntu-latest
    needs: [build-legacy, build-modern]
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest"]
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v4
      - name: Install pypa/build
        run: python -m pip install build --user
      - name: Build a binary wheel and a source tarball
        run: python -m build --sdist --wheel --outdir dist/ .
      - name: Publish distribution ðŸ“¦ to PyPI if Release
        if: startsWith(github.ref, 'refs/tags')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          skip_existing: true
      - name: Publish distribution ðŸ“¦ to Test PyPI if Push
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_TOKEN }}
          repository_url: https://test.pypi.org/legacy/
          skip_existing: true

  conda:
    name: (${{ matrix.python-version }}, ubuntu-latest)
    runs-on: ubuntu-latest
    needs: [build-legacy, build-modern]
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest"]
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v2
      - uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: ${{ matrix.python-version }}
          channels: conda-forge,cmutel,konstantinstadler,haasad,pascallesage,romainsacchi
          allow-softlinks: true
          channel-priority: strict
          auto-update-conda: true
          activate-environment: test
      - name: Conda info
        shell: bash -l {0}
        run: conda info
      - name: Git checkout
        uses: actions/checkout@v1
      - name: Branch name
        run: echo running on branch ${GITHUB_REF##*/}
      - name: Publish distribution ðŸ“¦ to Anaconda if Push
        if: github.ref == 'refs/heads/main'
        shell: bash -l {0}
        run: |
          PKG_NAME=unfold
          USER=romainsacchi
          conda install -y anaconda-client conda-build
          mkdir -p ~/conda-bld
          conda config --set anaconda_upload no
          export CONDA_BLD_PATH=~/conda-bld
          export VERSION=$(date +%Y.%m.%d)
          conda build conda/ --old-build-string
          ls -lah $CONDA_BLD_PATH/noarch/
          anaconda -t ${{ secrets.ANACONDA_CLOUD }} upload -u $USER $CONDA_BLD_PATH/noarch/$PKG_NAME-$VERSION-py_0.conda --force

  testconda:
    name: (${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: conda
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu-latest"]
        python-version: ["3.11"]
    steps:
      - uses: actions/checkout@v2
      - uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: 3.11
          channels: conda-forge,cmutel,konstantinstadler,haasad,pascallesage,romainsacchi
          allow-softlinks: true
          channel-priority: flexible
          auto-update-conda: true
          conda-build-version: 3.26.1
          activate-environment: test
      - name: Pull distribution ðŸ“¦ from Anaconda and test
        if: github.ref == 'refs/heads/main'
        shell: bash -l {0}
        run: |
          conda install -v -c romainsacchi unfold
          conda update unfold
          conda install pytest
          pytest
